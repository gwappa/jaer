/*
 * Copyright (C) 2017 Viktor Bahr, Keisuke Sehara
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 */
package de.cco.jaer.eval;

import com.jogamp.opengl.awt.GLCanvas;
import java.awt.Point;
import java.awt.Rectangle;
import java.awt.event.MouseEvent;
import java.awt.event.MouseListener;
import java.awt.event.MouseMotionListener;
import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.beans.PropertyChangeSupport;
import java.util.LinkedList;
import java.util.List;
import net.sf.jaer.graphics.ChipCanvas;

/**
 * GUI for controlling event evaluation, threshold type and value.
 *
 * @author viktor
 * @see ResultEvaluator
 * @see OutputHandler
 * @see EvaluatorThreshold
 */
public class EvaluatorFrame extends javax.swing.JFrame implements MouseListener, MouseMotionListener {

    /**
     * Handles event evaluation
     */
    private ResultEvaluator reval;

    /**
     * Handles different thresholds, passed to ResultEvalutor instance
     */
    private EvaluatorThreshold thresh;

    /**
     * Handles logging of threshold values
     */
    private final OutputHandler thresh_out;

    /**
     * Canvas object that represents DVS chip, used for getting event/mouse
     * position in pixel, size matches DVS chip size
     */
    private ChipCanvas canvas;

    /**
     * Canvas object representing drawable jAER surface, used for at-/detaching
     * mouse callbacks
     */
    private GLCanvas glCanvas;

    /**
     * True, if property change listener (see filterStateListener) is attached
     */
    private boolean listening;

    /**
     * True, while region of interest is being selected
     */
    private boolean selecting = false;

    /**
     * Region of interest rectangle
     */
    private Rectangle selection = null;

    /**
     * Point instances to describe region of interest rectangle
     */
    private Point start_point = null, end_point = null;

    /**
     * Coordinates of region of interest rectangle, default is (0,0,0,0)
     */
    private int startx, starty, endx, endy;

    /**
     * Holds filter specific PropertyChangeSupport objects, enables us to listen
     * for changes in more than one filter
     */
    private final List<PropertyChangeSupport> pcs_list;

    /**
     * Listens for changes in jAER filter list, evaluation is available, if at
     * least one filter is enabled, evaluation is disabled, if filters are
     * disabled
     */
    PropertyChangeListener filterStateListener = new PropertyChangeListener() {
        @Override
        public void propertyChange(PropertyChangeEvent pce) {
            if (pce.getPropertyName().equals("filterEnabled")) {
                boolean val = (boolean) pce.getNewValue();
                if (val == false) {
                    System.out.println("Filter disabled.");
                    System.out.println("Stopping evaluation.");
                    enableCheckBox.setSelected(false);
                    enableCheckBox.setEnabled(false);
                    drawCheckBox.setSelected(false);
                    drawCheckBox.setEnabled(false);
                    reval.draw(false);
                    reval.arm(false);
                } else if (val == true) {
                    System.out.println("Filter enabled.");
                    enableCheckBox.setEnabled(true);
                }
            }
        }
    };

    /**
     * Creates new form EvaluatorFrame
     */
    public EvaluatorFrame() {
        reval = ResultEvaluator.getInstance(); // get singelton instance
        pcs_list = new LinkedList<>();
        thresh_out = new OutputHandler(OutputHandler.OutputSource.FILE,
                "EvalThresholds",
                "type,system,value"); // threshold type, system clock and threshold value
        initComponents();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        enableCheckBox = new javax.swing.JCheckBox();
        drawCheckBox = new javax.swing.JCheckBox();
        tabbedPane = new javax.swing.JTabbedPane();
        ratePanel = new javax.swing.JPanel();
        rateSlider = new javax.swing.JSlider();
        rateLabel = new javax.swing.JLabel();
        posPanel = new javax.swing.JPanel();
        x1Spinner = new javax.swing.JSpinner();
        y1Spinner = new javax.swing.JSpinner();
        x2Spinner = new javax.swing.JSpinner();
        y2Spinner = new javax.swing.JSpinner();
        x1Label = new javax.swing.JLabel();
        y1Label = new javax.swing.JLabel();
        y2Label = new javax.swing.JLabel();
        x2Label = new javax.swing.JLabel();
        roiPanel = new javax.swing.JPanel();
        resetROIButton = new javax.swing.JButton();
        selectROIButton = new javax.swing.JToggleButton();
        speedPane = new javax.swing.JPanel();
        speedSlider = new javax.swing.JSlider();
        speedLabel = new javax.swing.JLabel();

        setTitle("ResultEvaluator");
        setResizable(false);

        enableCheckBox.setFont(new java.awt.Font("Dialog", 1, 14)); // NOI18N
        enableCheckBox.setText("Evaluate");
        enableCheckBox.setEnabled(false);
        enableCheckBox.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                enableCheckBoxActionPerformed(evt);
            }
        });

        drawCheckBox.setFont(new java.awt.Font("Dialog", 1, 14)); // NOI18N
        drawCheckBox.setText("Show");
        drawCheckBox.setEnabled(false);
        drawCheckBox.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                drawCheckBoxActionPerformed(evt);
            }
        });

        tabbedPane.addChangeListener(new javax.swing.event.ChangeListener() {
            public void stateChanged(javax.swing.event.ChangeEvent evt) {
                tabbedPaneStateChanged(evt);
            }
        });

        rateSlider.setMajorTickSpacing(50);
        rateSlider.setMaximum(500);
        rateSlider.setPaintLabels(true);
        rateSlider.setPaintTicks(true);
        rateSlider.addChangeListener(new javax.swing.event.ChangeListener() {
            public void stateChanged(javax.swing.event.ChangeEvent evt) {
                rateSliderStateChanged(evt);
            }
        });

        rateLabel.setText("# events / dt [µHz]");

        javax.swing.GroupLayout ratePanelLayout = new javax.swing.GroupLayout(ratePanel);
        ratePanel.setLayout(ratePanelLayout);
        ratePanelLayout.setHorizontalGroup(
            ratePanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(ratePanelLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(ratePanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.CENTER)
                    .addComponent(rateSlider, javax.swing.GroupLayout.DEFAULT_SIZE, 306, Short.MAX_VALUE)
                    .addComponent(rateLabel))
                .addContainerGap())
        );
        ratePanelLayout.setVerticalGroup(
            ratePanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(ratePanelLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(rateSlider, javax.swing.GroupLayout.PREFERRED_SIZE, 65, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(rateLabel)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        tabbedPane.addTab("Eventrate", ratePanel);

        x1Spinner.setValue(80);
        x1Spinner.addChangeListener(new javax.swing.event.ChangeListener() {
            public void stateChanged(javax.swing.event.ChangeEvent evt) {
                x1SpinnerStateChanged(evt);
            }
        });

        y1Spinner.setValue(30);
        y1Spinner.addChangeListener(new javax.swing.event.ChangeListener() {
            public void stateChanged(javax.swing.event.ChangeEvent evt) {
                y1SpinnerStateChanged(evt);
            }
        });

        x2Spinner.setValue(80);
        x2Spinner.addChangeListener(new javax.swing.event.ChangeListener() {
            public void stateChanged(javax.swing.event.ChangeEvent evt) {
                x2SpinnerStateChanged(evt);
            }
        });

        y2Spinner.setValue(100);
        y2Spinner.addChangeListener(new javax.swing.event.ChangeListener() {
            public void stateChanged(javax.swing.event.ChangeEvent evt) {
                y2SpinnerStateChanged(evt);
            }
        });

        x1Label.setText("X1:");

        y1Label.setText("Y1:");

        y2Label.setText("Y2:");

        x2Label.setText("X2:");

        javax.swing.GroupLayout posPanelLayout = new javax.swing.GroupLayout(posPanel);
        posPanel.setLayout(posPanelLayout);
        posPanelLayout.setHorizontalGroup(
            posPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(posPanelLayout.createSequentialGroup()
                .addGap(51, 51, 51)
                .addGroup(posPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addGroup(posPanelLayout.createSequentialGroup()
                        .addComponent(x2Label)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(x2Spinner, javax.swing.GroupLayout.PREFERRED_SIZE, 55, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(posPanelLayout.createSequentialGroup()
                        .addComponent(x1Label)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(x1Spinner, javax.swing.GroupLayout.PREFERRED_SIZE, 55, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 55, Short.MAX_VALUE)
                .addGroup(posPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, posPanelLayout.createSequentialGroup()
                        .addComponent(y1Label)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(y1Spinner, javax.swing.GroupLayout.PREFERRED_SIZE, 55, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, posPanelLayout.createSequentialGroup()
                        .addComponent(y2Label)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(y2Spinner, javax.swing.GroupLayout.PREFERRED_SIZE, 55, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addGap(46, 46, 46))
        );
        posPanelLayout.setVerticalGroup(
            posPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(posPanelLayout.createSequentialGroup()
                .addGap(15, 15, 15)
                .addGroup(posPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.CENTER)
                    .addComponent(x1Spinner, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(x1Label)
                    .addComponent(y1Label)
                    .addComponent(y1Spinner, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(posPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.CENTER)
                    .addComponent(x2Spinner, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(x2Label)
                    .addComponent(y2Label)
                    .addComponent(y2Spinner, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(22, Short.MAX_VALUE))
        );

        tabbedPane.addTab("Position", posPanel);

        resetROIButton.setText("Reset");
        resetROIButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                resetROIButtonActionPerformed(evt);
            }
        });

        selectROIButton.setText("Select");
        selectROIButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                selectROIButtonActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout roiPanelLayout = new javax.swing.GroupLayout(roiPanel);
        roiPanel.setLayout(roiPanelLayout);
        roiPanelLayout.setHorizontalGroup(
            roiPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(roiPanelLayout.createSequentialGroup()
                .addGap(50, 50, 50)
                .addComponent(selectROIButton, javax.swing.GroupLayout.PREFERRED_SIZE, 88, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 57, Short.MAX_VALUE)
                .addComponent(resetROIButton)
                .addGap(55, 55, 55))
        );
        roiPanelLayout.setVerticalGroup(
            roiPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(roiPanelLayout.createSequentialGroup()
                .addGap(36, 36, 36)
                .addGroup(roiPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(resetROIButton)
                    .addComponent(selectROIButton))
                .addContainerGap(40, Short.MAX_VALUE))
        );

        tabbedPane.addTab("Region", roiPanel);

        speedSlider.setMajorTickSpacing(5);
        speedSlider.setMaximum(40);
        speedSlider.setPaintLabels(true);
        speedSlider.setPaintTicks(true);
        speedSlider.setValue(5);
        speedSlider.addChangeListener(new javax.swing.event.ChangeListener() {
            public void stateChanged(javax.swing.event.ChangeEvent evt) {
                speedSliderStateChanged(evt);
            }
        });

        speedLabel.setText("(distance [px] / dt [µs]) * e-4 ");

        javax.swing.GroupLayout speedPaneLayout = new javax.swing.GroupLayout(speedPane);
        speedPane.setLayout(speedPaneLayout);
        speedPaneLayout.setHorizontalGroup(
            speedPaneLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(speedPaneLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(speedPaneLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.CENTER)
                    .addComponent(speedSlider, javax.swing.GroupLayout.DEFAULT_SIZE, 306, Short.MAX_VALUE)
                    .addComponent(speedLabel))
                .addContainerGap())
        );
        speedPaneLayout.setVerticalGroup(
            speedPaneLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(speedPaneLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(speedSlider, javax.swing.GroupLayout.PREFERRED_SIZE, 65, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(speedLabel)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        tabbedPane.addTab("Speed", speedPane);

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(15, 15, 15)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(tabbedPane)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(enableCheckBox)
                        .addGap(152, 152, 152)
                        .addComponent(drawCheckBox)))
                .addContainerGap(16, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(41, 41, 41)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(enableCheckBox)
                    .addComponent(drawCheckBox))
                .addGap(28, 28, 28)
                .addComponent(tabbedPane, javax.swing.GroupLayout.PREFERRED_SIZE, 132, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(44, Short.MAX_VALUE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    /**
     * Add state listener to jAER filter
     *
     * @param pcs Filter specific PropertyChangeSupport object
     */
    public synchronized void attachFilterStateListener(PropertyChangeSupport pcs) {
        pcs.addPropertyChangeListener(filterStateListener);
        pcs_list.add(pcs);
        if (!listening) {
            listening = true;
        }
    }

    /**
     * Remove state listener from jAER filters
     *
     * @param pcs Filter specific PropertyChangeSupport object
     */
    public synchronized void removeFilterStateListener(PropertyChangeSupport pcs) {
        pcs.removePropertyChangeListener(filterStateListener);
        listening = false;
    }

    /**
     * En-/Disable evaluation, checkbox callback, when evaluation is disabled,
     * drawing of tracker output is also disabled
     *
     * @param evt Callback event object
     */
    private void enableCheckBoxActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_enableCheckBoxActionPerformed
        boolean selected = enableCheckBox.isSelected();
        drawCheckBox.setEnabled(selected);
        reval.arm(selected);
        if (!selected) {
            drawCheckBox.setSelected(false);
            reval.draw(false);
        }
    }//GEN-LAST:event_enableCheckBoxActionPerformed

    /**
     * En-/Disable drawing of tracker information, checkbox callback
     *
     * @param evt Callback event object
     */
    private void drawCheckBoxActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_drawCheckBoxActionPerformed
        boolean selected = drawCheckBox.isSelected();
        reval.draw(selected);
    }//GEN-LAST:event_drawCheckBoxActionPerformed

    /**
     * Threshold type selection, tabbed pane callback, new EvaluatorThreshold
     * object is created and passed on to ResultEvaluator, if evaluation is
     * enabled, write threshold information to file
     *
     * @param evt Callback event object
     */
    private void tabbedPaneStateChanged(javax.swing.event.ChangeEvent evt) {//GEN-FIRST:event_tabbedPaneStateChanged
        long system = System.currentTimeMillis(); // get system clock for logging
        switch (tabbedPane.getTitleAt(tabbedPane.getSelectedIndex())) {
            case "Eventrate":
                thresh = new EvaluatorThreshold(EvaluatorThreshold.Parameter.EVENTRATE, (double) rateSlider.getValue());
                reval.setThreshold(thresh);
                if (enableCheckBox.isSelected()) {
                    thresh_out.write(thresh.getTarget().toString() + "," + system + "," + (double) rateSlider.getValue());
                }
                break;
            case "Position":
                int[] arr = getPositionSpinnerValues();
                thresh = new EvaluatorThreshold(EvaluatorThreshold.Parameter.POSITION, arr);
                reval.setThreshold(thresh);
                if (enableCheckBox.isSelected()) {
                    thresh_out.write(thresh.getTarget().toString() + "," + system + "," + arrayToString(arr));
                }
                break;
            case "Region":
                if (selection == null) {
                    selection = new Rectangle(0, 0, 0, 0);
                }
                thresh = new EvaluatorThreshold(EvaluatorThreshold.Parameter.REGION, selection);
                reval.setThreshold(thresh);
                if (enableCheckBox.isSelected()) {
                    thresh_out.write(thresh.getTarget().toString() + "," + system + "," + rectToString(selection));
                }
                break;
            case "Speed":
                thresh = new EvaluatorThreshold(EvaluatorThreshold.Parameter.SPEED, (double) speedSlider.getValue() * 1e-4);
                reval.setThreshold(thresh);
                if (enableCheckBox.isSelected()) {
                    thresh_out.write(thresh.getTarget().toString() + "," + system + "," + (double) speedSlider.getValue() * 1e-4);
                }
                break;
            default:
                break;
        }
    }//GEN-LAST:event_tabbedPaneStateChanged

    /**
     * Tracked object speed threshold, slider callback
     *
     * @param evt Callback event object
     */
    private void speedSliderStateChanged(javax.swing.event.ChangeEvent evt) {//GEN-FIRST:event_speedSliderStateChanged
        thresh.setValue((double) speedSlider.getValue() * 1e-4);
        if (enableCheckBox.isSelected()) {
            long system = System.currentTimeMillis();
            thresh_out.write(thresh.getTarget().toString() + "," + system + "," + (double) speedSlider.getValue() * 1e-4);
        }
    }//GEN-LAST:event_speedSliderStateChanged

    /**
     * DVS event rate threshold, slider callback
     *
     * @param evt Callback event object
     */
    private void rateSliderStateChanged(javax.swing.event.ChangeEvent evt) {//GEN-FIRST:event_rateSliderStateChanged
        thresh.setValue((double) rateSlider.getValue());
        if (enableCheckBox.isSelected()) {
            long system = System.currentTimeMillis();
            thresh_out.write(thresh.getTarget().toString() + "," + system + "," + (double) rateSlider.getValue());
        }
    }//GEN-LAST:event_rateSliderStateChanged

    /**
     * Manual region threshold, spinner control callback [X1 Y1; X2 Y2]
     *
     * @param evt Callback event object
     */
    private void x1SpinnerStateChanged(javax.swing.event.ChangeEvent evt) {//GEN-FIRST:event_x1SpinnerStateChanged
        int[] arr = getPositionSpinnerValues();
        thresh = new EvaluatorThreshold(EvaluatorThreshold.Parameter.POSITION, arr);
        if (enableCheckBox.isSelected()) {
            long system = System.currentTimeMillis();
            thresh_out.write(thresh.getTarget().toString() + "," + system + "," + arrayToString(arr));
        }
        reval.setThreshold(thresh);
    }//GEN-LAST:event_x1SpinnerStateChanged

    /**
     * Manual region threshold, spinner control callback [X1 Y1; X2 Y2]
     *
     * @param evt Callback event object
     */
    private void y1SpinnerStateChanged(javax.swing.event.ChangeEvent evt) {//GEN-FIRST:event_y1SpinnerStateChanged
        int[] arr = getPositionSpinnerValues();
        thresh = new EvaluatorThreshold(EvaluatorThreshold.Parameter.POSITION, arr);
        if (enableCheckBox.isSelected()) {
            long system = System.currentTimeMillis();
            thresh_out.write(thresh.getTarget().toString() + "," + system + "," + arrayToString(arr));
        }

        reval.setThreshold(thresh);
    }//GEN-LAST:event_y1SpinnerStateChanged

    /**
     * Manual region threshold, spinner control callback [X1 Y1; X2 Y2]
     *
     * @param evt Callback event object
     */
    private void x2SpinnerStateChanged(javax.swing.event.ChangeEvent evt) {//GEN-FIRST:event_x2SpinnerStateChanged
        int[] arr = getPositionSpinnerValues();
        thresh = new EvaluatorThreshold(EvaluatorThreshold.Parameter.POSITION, arr);
        if (enableCheckBox.isSelected()) {
            long system = System.currentTimeMillis();
            thresh_out.write(thresh.getTarget().toString() + "," + system + "," + arrayToString(arr));
        }
        reval.setThreshold(thresh);
    }//GEN-LAST:event_x2SpinnerStateChanged

    /**
     * Manual region threshold, spinner control callback [X1 Y1; X2 Y2]
     *
     * @param evt Callback event object
     */
    private void y2SpinnerStateChanged(javax.swing.event.ChangeEvent evt) {//GEN-FIRST:event_y2SpinnerStateChanged
        int[] arr = getPositionSpinnerValues();
        thresh = new EvaluatorThreshold(EvaluatorThreshold.Parameter.POSITION, arr);
        if (enableCheckBox.isSelected()) {
            long system = System.currentTimeMillis();
            thresh_out.write(thresh.getTarget().toString() + "," + system + "," + arrayToString(arr));
        }
        reval.setThreshold(thresh);
    }//GEN-LAST:event_y2SpinnerStateChanged

    /**
     * Reset user defined region of interest, button callback, remove mouse
     * listeners from canvas object
     *
     * @param evt Callback event object
     */
    private void resetROIButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_resetROIButtonActionPerformed
        glCanvas.removeMouseListener(this);
        glCanvas.removeMouseMotionListener(this);
        selection = new Rectangle(0, 0, 0, 0);
        if (enableCheckBox.isSelected()) {
            long system = System.currentTimeMillis();
            thresh_out.write(thresh.getTarget().toString() + "," + system + "," + rectToString(selection));
        }
        reval.getThreshold().setValue(selection);
    }//GEN-LAST:event_resetROIButtonActionPerformed

    /**
     * Let user select region of interest with mouse, button callback, attach
     * mouse listener to jAER canvas object
     *
     * @param evt Callback event object
     */
    private void selectROIButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_selectROIButtonActionPerformed
        if (!selectROIButton.isSelected() || selecting) {
            return;
        }
        if ((reval.getParams().getChip().getCanvas() != null)
                && (reval.getParams().getChip().getCanvas().getCanvas() != null)) {
            canvas = reval.getParams().getChip().getCanvas();
            glCanvas = (GLCanvas) reval.getParams().getChip().getCanvas().getCanvas();
        } else {
            selectROIButton.setSelected(false);
            return;
        }
        selecting = true;
        glCanvas.removeMouseListener(this);
        glCanvas.removeMouseMotionListener(this);
        glCanvas.addMouseListener(this);
        glCanvas.addMouseMotionListener(this);
    }//GEN-LAST:event_selectROIButtonActionPerformed

    /**
     * @return Is filterStateListener attached to jAER filter(s)?
     */
    public boolean isListening() {
        return listening;
    }

    /**
     * @return Is region of interest currently being drawn?
     */
    public boolean isSelecting() {
        return selecting;
    }

    /**
     * Getter for OutputHandler object tasked with logging threshold information
     *
     * @return OutputHandler object
     */
    public OutputHandler getOutputHandler() {
        return thresh_out;
    }

    /**
     * Getter for manual region threshold positions
     *
     * @return 1x4 array, [x1, y1, x2, y2]
     */
    private int[] getPositionSpinnerValues() {
        try {
            x1Spinner.commitEdit();
            y1Spinner.commitEdit();
            x2Spinner.commitEdit();
            y2Spinner.commitEdit();
        } catch (java.text.ParseException e) {
        }
        int x1 = (int) x1Spinner.getValue();
        int y1 = (int) y1Spinner.getValue();
        int x2 = (int) x2Spinner.getValue();
        int y2 = (int) y2Spinner.getValue();
        int[] arr = {x1, y1, x2, y2};
        return arr;
    }

    /**
     * Convert integer array to string
     *
     * @param arr Array of integers
     * @return String of space seperated integers in square brackets (e.g. "[1 2 3]")
     */
    private String arrayToString(int[] arr) {
        String out = "[";
        for (int i = 0; i < arr.length; i++) {
            out += arr[i] + " ";
        }
        return out.substring(0, out.length() - 1) + "]";
    }

    /**
     * Convert Rectangle type to string
     *
     * @param rect Rectangle object
     * @return String of rectangle coordinates in square brackets (e.g. "[1, 1, 2, 2]")
     */
    private String rectToString(Rectangle rect) {
        int x2 = rect.x + rect.height;
        int y2 = rect.y + rect.width;
        return "[" + rect.x + " " + rect.y + " " + x2 + " " + y2 + "]";
    }

    /**
     * Update selection rectangle object with pixel values from mouse selection
     *
     * @param me MouseListener callback event
     * @return Mouse selected region of interest
     */
    private Rectangle updateSelection(MouseEvent me) {
        end_point = canvas.getPixelFromMouseEvent(me);
        startx = min(start_point.x, end_point.x);
        starty = min(start_point.y, end_point.y);
        endx = max(start_point.x, end_point.x);
        endy = max(start_point.y, end_point.y);
        int w = endx - startx;
        int h = endy - starty;
        selection = new Rectangle(startx, starty, w, h);
        return selection;
    }

    /**
     * Do nothing after left mouse button has been clicked
     *
     * @param me MouseEvent callback event object
     */
    @Override
    public void mouseClicked(MouseEvent me) {
    }

    /**
     * When left mouse button is pressed, get current mouse position and store
     * it as start point of region of interest rectangle
     *
     * @param me MouseEvent callback event object
     */
    @Override
    public void mousePressed(MouseEvent me) {
        if (!selecting) {
            return;
        }
        canvas = reval.getParams().getChip().getCanvas();
        Point p = canvas.getPixelFromMouseEvent(me);
        start_point = p;
    }

    /**
     * When left mouse button is released, get current mouse position and
     * generate region of interest rectangle object, clip rectangle to chip
     * size, update EvaluatorThreshold object
     *
     * @param me MouseEvent callback event object
     */
    @Override
    public void mouseReleased(MouseEvent me) {
        if ((start_point == null)
                || canvas.getPixelFromMouseEvent(me).equals(start_point)
                || !selecting) {
            return;
        }
        selection = updateSelection(me);
        int szx = reval.getParams().getChip().getSizeX();
        int szy = reval.getParams().getChip().getSizeY();
        startx = clip(startx, szx);
        starty = clip(starty, szy);
        endx = clip(endx, szx);
        endy = clip(endy, szy);
        selecting = false;
        selectROIButton.setSelected(false);
        thresh.setValue(selection);
        if (enableCheckBox.isSelected()) {
            long system = System.currentTimeMillis();
            thresh_out.write(thresh.getTarget().toString() + "," + system + "," + rectToString(selection));
        }
    }

    /**
     * Do nothing when mouse mode entered
     *
     * @param me MouseEvent callback event object
     */
    @Override
    public void mouseEntered(MouseEvent me) {
    }

    /**
     * Abort selection
     *
     * @param me MouseEvent callback event object
     */
    @Override
    public void mouseExited(MouseEvent me) {
        selecting = false;
        selectROIButton.setSelected(false);
    }

    /**
     * While mouse with pressed left mouse button is being dragged update
     * selection and threshold with current mouse position values
     *
     * @param me MouseEvent callback event object
     */
    @Override
    public void mouseDragged(MouseEvent me) {
        if (start_point == null || !selecting) {
            return;
        }
        selection = updateSelection(me);
        reval.getThreshold().setValue(selection); // TODO: Is this neccesary?
    }

    /**
     * Do nothing when mouse is moved (no button pressed)
     *
     * @param me MouseEvent callback event object
     */
    @Override
    public void mouseMoved(MouseEvent me) {
    }

    /**
     * Get minimum of two integers
     *
     * @param a An integer
     * @param b Another integer
     * @return Minum of a and b
     */
    private int min(int a, int b) {
        return a < b ? a : b;
    }

    /**
     * Get maximum of two integers
     *
     * @param a An integer
     * @param b Another integer
     * @return Maximum of a and b
     */
    private int max(int a, int b) {
        return a > b ? a : b;
    }

    /**
     * Clip value to limit
     *
     * @param val An integer
     * @param limit An upper bound limit, range is [0, limit)
     * @return Clipped value
     */
    private int clip(int val, int limit) {
        if ((val > limit) && (limit != 0)) {
            return limit;
        } else if (val < 0) {
            return 0;
        }
        return val;
    }

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException ex) {
            java.util.logging.Logger.getLogger(EvaluatorFrame.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (InstantiationException ex) {
            java.util.logging.Logger.getLogger(EvaluatorFrame.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (IllegalAccessException ex) {
            java.util.logging.Logger.getLogger(EvaluatorFrame.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(EvaluatorFrame.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>

        /* Create and display the form */
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                new EvaluatorFrame().setVisible(true);
            }
        });
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JCheckBox drawCheckBox;
    private javax.swing.JCheckBox enableCheckBox;
    private javax.swing.JPanel posPanel;
    private javax.swing.JLabel rateLabel;
    private javax.swing.JPanel ratePanel;
    private javax.swing.JSlider rateSlider;
    private javax.swing.JButton resetROIButton;
    private javax.swing.JPanel roiPanel;
    private javax.swing.JToggleButton selectROIButton;
    private javax.swing.JLabel speedLabel;
    private javax.swing.JPanel speedPane;
    private javax.swing.JSlider speedSlider;
    private javax.swing.JTabbedPane tabbedPane;
    private javax.swing.JLabel x1Label;
    private javax.swing.JSpinner x1Spinner;
    private javax.swing.JLabel x2Label;
    private javax.swing.JSpinner x2Spinner;
    private javax.swing.JLabel y1Label;
    private javax.swing.JSpinner y1Spinner;
    private javax.swing.JLabel y2Label;
    private javax.swing.JSpinner y2Spinner;
    // End of variables declaration//GEN-END:variables

}
